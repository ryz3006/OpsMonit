<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Work Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot, orderBy, where, deleteDoc, limit, startAfter, getDocs, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
            getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot, orderBy, where, deleteDoc, limit, startAfter, getDocs, updateDoc, arrayUnion, serverTimestamp
        };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            display: flex;
        }
        .timer-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCCOH7T907XnZoGxJaESLQghUE0xSDPiHk",
            authDomain: "dalignzo.firebaseapp.com",
            projectId: "dalignzo",
            storageBucket: "dalignzo.appspot.com",
            messagingSenderId: "901156603087",
            appId: "1:901156603087:web:c95c9f4f714f8f0be263ba",
            measurementId: "G-36S66F65D6"
        };
        
        let app, auth, db;
        try {
            app = window.firebase.initializeApp(firebaseConfig);
            auth = window.firebase.getAuth(app);
            db = window.firebase.getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization error:", e);
        }

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            
            useEffect(() => {
                const unsubscribeAuth = window.firebase.onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribeAuth();
            }, []);

            const handleGoogleSignIn = async () => {
                const provider = new window.firebase.GoogleAuthProvider();
                try {
                    await window.firebase.signInWithPopup(auth, provider);
                    setAuthError(null);
                } catch (error) {
                    console.error("Google Sign-in failed", error);
                    setAuthError(`Google Sign-in failed: ${error.message}`);
                }
            };
            
            const handleLogout = async () => {
                try {
                    await window.firebase.signOut(auth);
                } catch (error) {
                    console.error("Logout failed", error);
                }
            };


            if (loading) return <div className="text-center p-10">Loading Application...</div>;

            return (
                <div>
                    {user ? <Dashboard user={user} onLogout={handleLogout} /> : <LoginScreen onLogin={handleGoogleSignIn} error={authError} />}
                </div>
            );
        }
        
        // --- Screens ---

        function LoginScreen({ onLogin, error }) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50">
                    <div className="text-center p-8 bg-white shadow-xl rounded-2xl max-w-md w-full">
                        <i className="fas fa-tasks fa-3x text-blue-600 mb-4"></i>
                        <h1 className="text-3xl font-bold text-gray-800">Work Tracker</h1>
                        <p className="text-gray-500 mt-2 mb-8">Log your work, track your time, stay productive.</p>
                        <button
                            onClick={onLogin}
                            className="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center"
                        >
                            <img src="https://www.google.com/favicon.ico" alt="Google icon" className="w-6 h-6 mr-3" />
                            Sign in with Google
                        </button>
                        {error && <p className="text-red-500 text-sm mt-4">{error}</p>}
                    </div>
                </div>
            );
        }

        function Dashboard({ user, onLogout }) {
            const defaultSettings = { projects: [], customFields: [], confirmationTime: 30, autoStopTime: 60 };
            const [settings, setSettings] = useState(defaultSettings);
            const [workLogs, setWorkLogs] = useState([]);
            const [lastVisible, setLastVisible] = useState(null);
            const [isLastPage, setIsLastPage] = useState(false);
            
            const [isSettingsModalOpen, setSettingsModalOpen] = useState(false);
            const [isWorkLogModalOpen, setWorkLogModalOpen] = useState(false);
            const [isUploadModalOpen, setUploadModalOpen] = useState(false);
            
            const [liveTimers, setLiveTimers] = useState([]);
            const [activeTimerModalId, setActiveTimerModalId] = useState(null);

            const fetchWorkLogs = useCallback(async (next = false) => {
                // REVERTED: This query now relies on the Firebase index.
                // The user MUST create this index in the Firebase console.
                let q = window.firebase.query(
                    window.firebase.collection(db, "manual_work_reports"),
                    window.firebase.where("user.email", "==", user.email),
                    window.firebase.orderBy("startTime", "desc"),
                    window.firebase.limit(25)
                );

                if (next && lastVisible) {
                    q = window.firebase.query(q, window.firebase.startAfter(lastVisible));
                }
                
                try {
                    const documentSnapshots = await window.firebase.getDocs(q);
                    const logs = [];
                    documentSnapshots.forEach((doc) => {
                        logs.push({ id: doc.id, ...doc.data() });
                    });
                    
                    setWorkLogs(logs);
                    setLastVisible(documentSnapshots.docs[documentSnapshots.docs.length - 1]);
                    setIsLastPage(documentSnapshots.docs.length < 25);
                } catch(e) {
                    console.error("Error fetching work logs:", e);
                    if (e.code === 'failed-precondition') {
                        alert("A database index is required for this query. Please follow the link in the console to create it.");
                    }
                }
            }, [user, lastVisible]);


            useEffect(() => {
                if (!user) return;
                const settingsDocRef = window.firebase.doc(db, "app_settings", "config");
                const unsubscribeSettings = window.firebase.onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSettings({ ...defaultSettings, ...docSnap.data() });
                    } else {
                        window.firebase.setDoc(settingsDocRef, defaultSettings);
                    }
                });

                const liveTimersQuery = window.firebase.query(
                    window.firebase.collection(db, `live_timers/${user.uid}/timers`)
                );
                const unsubscribeLiveTimers = window.firebase.onSnapshot(liveTimersQuery, (snapshot) => {
                    const timers = [];
                    snapshot.forEach(doc => timers.push({ id: doc.id, ...doc.data() }));
                    setLiveTimers(timers);
                });

                fetchWorkLogs();

                return () => {
                    unsubscribeSettings();
                    unsubscribeLiveTimers();
                };
            }, [user]);

            const handleSaveWorkLog = async (logData) => {
                if (logData.isLive) {
                    await window.firebase.addDoc(window.firebase.collection(db, `live_timers/${user.uid}/timers`), logData);
                } else {
                    await window.firebase.addDoc(window.firebase.collection(db, "manual_work_reports"), logData);
                    fetchWorkLogs();
                }
                setWorkLogModalOpen(false);
            };

            const activeTimerData = liveTimers.find(t => t.id === activeTimerModalId);

            return (
                <div className="container mx-auto p-4 md:p-8 font-sans">
                    <header className="flex justify-between items-center mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Work Tracker</h1>
                        <div className="flex items-center space-x-4">
                            <NotificationBell timers={liveTimers} onRestore={setActiveTimerModalId} />
                            <div className="text-right">
                                <p className="font-semibold">{user.displayName}</p>
                                <p className="text-xs text-gray-500">{user.email}</p>
                            </div>
                            <img src={user.photoURL} alt="User profile" className="w-10 h-10 rounded-full" />
                            <button onClick={onLogout} className="text-gray-500 hover:text-red-600" title="Logout"><i className="fas fa-sign-out-alt fa-lg"></i></button>
                            <button onClick={() => setSettingsModalOpen(true)} className="text-gray-500 hover:text-blue-600" title="Settings"><i className="fas fa-cog fa-lg"></i></button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <button onClick={() => setWorkLogModalOpen(true)} className="p-6 bg-green-500 text-white rounded-lg shadow-lg hover:bg-green-600 transition flex items-center justify-center text-xl font-semibold">
                            <i className="fas fa-play-circle mr-3"></i> Start New Work
                        </button>
                        <button onClick={() => { /* Logic for old work */ }} className="p-6 bg-blue-500 text-white rounded-lg shadow-lg hover:bg-blue-600 transition flex items-center justify-center text-xl font-semibold">
                            <i className="fas fa-plus-circle mr-3"></i> Add Old Work
                        </button>
                        <button onClick={() => setUploadModalOpen(true)} className="p-6 bg-purple-500 text-white rounded-lg shadow-lg hover:bg-purple-600 transition flex items-center justify-center text-xl font-semibold cursor-pointer">
                            <i className="fas fa-upload mr-3"></i> Upload CSV
                        </button>
                    </div>

                    <WorkLogsTable logs={workLogs} user={user} onNextPage={() => fetchWorkLogs(true)} isLastPage={isLastPage} />
                    
                    {isSettingsModalOpen && <SettingsModal settings={settings} onClose={() => setSettingsModalOpen(false)} />}
                    {isWorkLogModalOpen && <WorkLogModal settings={settings} user={user} onSave={handleSaveWorkLog} onClose={() => setWorkLogModalOpen(false)} />}
                    {isUploadModalOpen && <UploadModal user={user} currentProjects={settings.projects} onClose={() => setUploadModalOpen(false)} />}
                    {activeTimerData && <LiveTimerModal timerData={activeTimerData} user={user} onStop={() => setActiveTimerModalId(null)} onMinimize={() => setActiveTimerModalId(null)} />}
                </div>
            );
        }

        // --- Child Components ---
        
        function NotificationBell({ timers, onRestore }) {
            const [isOpen, setIsOpen] = useState(false);
            if (timers.length === 0) return null;

            return (
                <div className="relative">
                    <button onClick={() => setIsOpen(!isOpen)} className="text-gray-500 hover:text-blue-600 relative">
                        <i className="fas fa-bell fa-lg"></i>
                        <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">{timers.length}</span>
                    </button>
                    {isOpen && (
                        <div className="absolute right-0 mt-2 w-72 bg-white rounded-md shadow-lg z-10">
                            <div className="p-2 font-semibold border-b">Ongoing Tasks</div>
                            <div className="p-2 max-h-64 overflow-y-auto">
                                {timers.map(timer => (
                                    <div key={timer.id} className="mb-2 p-2 hover:bg-gray-100 rounded">
                                        <p className="font-semibold text-sm truncate">{timer.project}: {timer.ticketLink}</p>
                                        <div className="flex justify-between items-center">
                                            <span className={`text-xs ${timer.isPaused ? 'text-yellow-600' : 'text-green-600'}`}>{timer.isPaused ? 'Paused' : 'Running'}</span>
                                            <button onClick={() => { onRestore(timer.id); setIsOpen(false); }} className="text-blue-600 text-sm">View</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function LiveTimerModal({ timerData, user, onStop, onMinimize }) {
            const [elapsed, setElapsed] = useState(0);
            const timerRef = useRef(null);

            useEffect(() => {
                const calculateElapsed = () => {
                    if (timerData.isPaused) {
                        return timerData.totalElapsedTime || 0;
                    }
                    const now = Date.now();
                    const resumeTime = timerData.lastResumedTime?.toMillis() || timerData.startTime.toMillis();
                    const baseElapsedTime = timerData.totalElapsedTime || 0;
                    return baseElapsedTime + (now - resumeTime);
                };

                setElapsed(calculateElapsed());

                if (!timerData.isPaused) {
                    timerRef.current = setInterval(() => setElapsed(calculateElapsed()), 1000);
                }

                return () => clearInterval(timerRef.current);
            }, [timerData]);

            const handlePause = async () => {
                clearInterval(timerRef.current);
                const timerDocRef = window.firebase.doc(db, `live_timers/${user.uid}/timers`, timerData.id);
                const now = Date.now();
                const resumeTime = timerData.lastResumedTime?.toMillis() || timerData.startTime.toMillis();
                const newElapsedTime = (timerData.totalElapsedTime || 0) + (now - resumeTime);
                await window.firebase.updateDoc(timerDocRef, {
                    isPaused: true,
                    totalElapsedTime: newElapsedTime
                });
            };
            
            const handleResume = async () => {
                const timerDocRef = window.firebase.doc(db, `live_timers/${user.uid}/timers`, timerData.id);
                await window.firebase.updateDoc(timerDocRef, {
                    isPaused: false,
                    lastResumedTime: window.firebase.serverTimestamp()
                });
            };

            const handleStop = async () => {
                clearInterval(timerRef.current);
                const finalEndTime = new Date();
                const finalLog = {
                    ...timerData,
                    endTime: finalEndTime,
                    isLive: false,
                };
                delete finalLog.id;
                delete finalLog.isPaused;
                delete finalLog.totalElapsedTime;
                delete finalLog.lastResumedTime;

                await window.firebase.addDoc(window.firebase.collection(db, "manual_work_reports"), finalLog);
                await window.firebase.deleteDoc(window.firebase.doc(db, `live_timers/${user.uid}/timers`, timerData.id));
                onStop();
            };

            const formatTime = (ms) => {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg">
                        <h2 className="text-2xl font-bold mb-2">Timer Running</h2>
                        <p className="text-gray-600 mb-4">{timerData.project}: {timerData.ticketLink}</p>
                        <p className="text-6xl font-mono text-center my-8 text-green-600">{formatTime(elapsed)}</p>
                        <div className="flex justify-between items-center">
                            <button onClick={onMinimize} className="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300">Minimize</button>
                            <div>
                                {timerData.isPaused ? (
                                    <button onClick={handleResume} className="py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 mr-2">Resume</button>
                                ) : (
                                    <button onClick={handlePause} className="py-2 px-4 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 mr-2">Pause</button>
                                )}
                                <button onClick={handleStop} className="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600">Stop</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function WorkLogsTable({ logs, user, onNextPage, isLastPage }) {
            const [selectedLogs, setSelectedLogs] = useState([]);

            const handleDelete = async (ids) => {
                if (!window.confirm(`Are you sure you want to delete ${ids.length} log(s)?`)) return;
                
                for (const id of ids) {
                    await window.firebase.deleteDoc(window.firebase.doc(db, "manual_work_reports", id));
                }
                setSelectedLogs([]);
            };

            const formatTime = (timestamp) => timestamp ? new Date(timestamp.seconds * 1000).toLocaleString() : 'N/A';
            const formatDuration = (start, end) => {
                if (!start || !end) return 'In Progress';
                const diff = (end.seconds - start.seconds) * 1000;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                return `${hours}h ${minutes}m`;
            };

            return (
                <div className="bg-white p-4 rounded-lg shadow-md">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-700">My Work Logs</h2>
                        {selectedLogs.length > 0 && (
                            <button onClick={() => handleDelete(selectedLogs)} className="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition">
                                <i className="fas fa-trash-alt mr-2"></i>Delete Selected ({selectedLogs.length})
                            </button>
                        )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead>
                                <tr className="bg-gray-50 border-b">
                                    <th className="p-3 w-4"><input type="checkbox" onChange={(e) => setSelectedLogs(e.target.checked ? logs.map(l => l.id) : [])} /></th>
                                    <th className="p-3">Project</th>
                                    <th className="p-3">Ticket/Task</th>
                                    <th className="p-3">Start Time</th>
                                    <th className="p-3">End Time</th>
                                    <th className="p-3">Duration</th>
                                    <th className="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {logs.map(log => (
                                    <tr key={log.id} className={`border-b ${selectedLogs.includes(log.id) ? 'bg-blue-50' : 'hover:bg-gray-50'}`}>
                                        <td className="p-3"><input type="checkbox" checked={selectedLogs.includes(log.id)} onChange={() => setSelectedLogs(p => p.includes(log.id) ? p.filter(id => id !== log.id) : [...p, log.id])} /></td>
                                        <td className="p-3 font-medium">{log.project}</td>
                                        <td className="p-3">{log.ticketLink}</td>
                                        <td className="p-3">{formatTime(log.startTime)}</td>
                                        <td className="p-3">{formatTime(log.endTime)}</td>
                                        <td className="p-3 font-mono">{formatDuration(log.startTime, log.endTime)}</td>
                                        <td className="p-3">
                                            <button onClick={() => handleDelete([log.id])} className="text-gray-400 hover:text-red-500"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                     <div className="flex justify-end mt-4">
                        <button onClick={onNextPage} disabled={isLastPage} className="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 disabled:bg-gray-400">Next Page</button>
                    </div>
                </div>
            );
        }

        function SettingsModal({ settings, onClose }) {
            const [localSettings, setLocalSettings] = useState(JSON.parse(JSON.stringify(settings)));
            
            const handleSave = async () => {
                const settingsDocRef = window.firebase.doc(db, "app_settings", "config");
                const settingsToSave = {
                    projects: localSettings.projects || [],
                    customFields: localSettings.customFields || [],
                    confirmationTime: Number(localSettings.confirmationTime) || 30,
                    autoStopTime: Number(localSettings.autoStopTime) || 60,
                };
                await window.firebase.setDoc(settingsDocRef, settingsToSave);
                onClose();
            };
            
            const addProject = () => {
                const newProject = prompt("Enter new project name:");
                if(newProject) setLocalSettings(s => ({ ...s, projects: [...s.projects, newProject] }));
            };
            const removeProject = (index) => {
                setLocalSettings(s => ({ ...s, projects: s.projects.filter((_, i) => i !== index) }));
            };

            const addCustomField = () => {
                const newField = prompt("Enter new custom field label (e.g., Issue Source):");
                if(newField) setLocalSettings(s => ({ ...s, customFields: [...(s.customFields || []), { label: newField, type: 'text' }] }));
            };
            const removeCustomField = (index) => {
                setLocalSettings(s => ({ ...s, customFields: s.customFields.filter((_, i) => i !== index) }));
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl max-h-full overflow-y-auto">
                        <h2 className="text-2xl font-bold mb-6">Settings</h2>
                        
                        <div className="mb-6">
                            <h3 className="font-semibold text-lg mb-2">Timer Configuration</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Confirmation prompt time (minutes)</label>
                                    <input type="number" value={localSettings.confirmationTime} onChange={e => setLocalSettings(s => ({ ...s, confirmationTime: Number(e.target.value) }))} className="mt-1 block w-full p-2 border rounded-md"/>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Auto-stop time after prompt (seconds)</label>
                                    <input type="number" value={localSettings.autoStopTime} onChange={e => setLocalSettings(s => ({ ...s, autoStopTime: Number(e.target.value) }))} className="mt-1 block w-full p-2 border rounded-md"/>
                                </div>
                            </div>
                        </div>

                        <div className="mb-6">
                            <h3 className="font-semibold text-lg mb-2">Projects</h3>
                            <div className="space-y-2">
                                {localSettings.projects.map((p, i) => (
                                    <div key={i} className="flex justify-between items-center bg-gray-100 p-2 rounded">
                                        <span>{p}</span>
                                        <button onClick={() => removeProject(i)} className="text-red-500 hover:text-red-700">Remove</button>
                                    </div>
                                ))}
                            </div>
                            <button onClick={addProject} className="mt-2 text-blue-600 font-semibold">Add Project</button>
                        </div>
                        
                        <div className="mb-6">
                            <h3 className="font-semibold text-lg mb-2">Custom Work Log Fields</h3>
                            <div className="space-y-2">
                                {(localSettings.customFields || []).map((f, i) => (
                                    <div key={i} className="flex justify-between items-center bg-gray-100 p-2 rounded">
                                        <span>{f.label}</span>
                                        <button onClick={() => removeCustomField(i)} className="text-red-500 hover:text-red-700">Remove</button>
                                    </div>
                                ))}
                            </div>
                            <button onClick={addCustomField} className="mt-2 text-blue-600 font-semibold">Add Custom Field</button>
                        </div>

                        <div className="flex justify-end space-x-4 mt-8">
                            <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button onClick={handleSave} className="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                        </div>
                    </div>
                </div>
            );
        }

        function WorkLogModal({ settings, user, onSave, onClose }) {
            const [formData, setFormData] = useState({
                project: settings.projects[0] || '',
                ticketLink: '',
                description: '',
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                const now = new Date();
                const logData = {
                    ...formData,
                    user: { uid: user.uid, name: user.displayName, email: user.email },
                    isLive: true,
                    startTime: now,
                    lastResumedTime: now,
                    endTime: null,
                    isPaused: false,
                    totalElapsedTime: 0,
                };
                onSave(logData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg">
                        <h2 className="text-2xl font-bold mb-6">Start New Work</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Project</label>
                                <select name="project" value={formData.project} onChange={(e) => setFormData(p => ({...p, project: e.target.value}))} className="mt-1 block w-full p-2 border rounded-md" required>
                                    {settings.projects.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Ticket Link / Task Name</label>
                                <input type="text" name="ticketLink" value={formData.ticketLink} onChange={(e) => setFormData(p => ({...p, ticketLink: e.target.value}))} className="mt-1 block w-full p-2 border rounded-md" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="description" value={formData.description} onChange={(e) => setFormData(p => ({...p, description: e.target.value}))} rows="3" className="mt-1 block w-full p-2 border rounded-md"></textarea>
                            </div>
                        </div>
                        <div className="flex justify-end space-x-4 mt-8">
                            <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button type="submit" className="py-2 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700">Start Timer</button>
                        </div>
                    </form>
                </div>
            );
        }

        function UploadModal({ user, currentProjects, onClose }) {
            const [file, setFile] = useState(null);
            const [progress, setProgress] = useState(0);
            const [total, setTotal] = useState(0);
            const [isUploading, setUploading] = useState(false);
            const isCancelledRef = useRef(false);
            const fileInputRef = useRef(null);

            const handleFileSelect = (event) => {
                const selectedFile = event.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    handleUpload(selectedFile);
                }
            };

            const parseCustomDate = (dateStr, timeStr) => {
                if (!dateStr || !timeStr) return null;
                const dateParts = dateStr.split('/');
                const timeParts = timeStr.split(':');
                if (dateParts.length !== 3 || timeParts.length !== 3) return null;
                const date = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]);
                return isNaN(date.getTime()) ? null : date;
            };

            const handleUpload = (fileToUpload) => {
                isCancelledRef.current = false;
                setUploading(true);
                Papa.parse(fileToUpload, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const records = results.data;
                        const newProjects = new Set();
                        setTotal(records.length);
                        
                        for (let i = 0; i < records.length; i++) {
                            if (isCancelledRef.current) break;
                            const record = records[i];
                            if (record.Project && !currentProjects.includes(record.Project)) {
                                newProjects.add(record.Project);
                            }
                            const startTime = parseCustomDate(record['Start Date'], record['Start Time']);
                            const endTime = parseCustomDate(record['End Date'], record['End Time']);

                            if (startTime && endTime && record.Email) {
                                const logData = {
                                    project: record.Project || 'N/A',
                                    ticketLink: record.Task || 'N/A',
                                    description: record.Description || '',
                                    startTime, endTime,
                                    user: { email: record.Email },
                                    uploader: { name: user.displayName, email: user.email },
                                    isLive: false,
                                };
                                await window.firebase.addDoc(window.firebase.collection(db, "manual_work_reports"), logData);
                            }
                            setProgress(i + 1);
                        }

                        if (newProjects.size > 0) {
                            const settingsDocRef = window.firebase.doc(db, "app_settings", "config");
                            await window.firebase.updateDoc(settingsDocRef, {
                                projects: window.firebase.arrayUnion(...Array.from(newProjects))
                            });
                        }
                        setUploading(false);
                    }
                });
            };

            const handleCancel = () => {
                isCancelledRef.current = true;
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold">Upload CSV</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>

                        {!file && (
                            <div className="text-center">
                                <p className="mb-4">Select a CSV file to upload work logs.</p>
                                <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileSelect} className="hidden" />
                                <button onClick={() => fileInputRef.current.click()} className="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Choose File
                                </button>
                            </div>
                        )}

                        {file && (
                            <div>
                                <p className="mb-2 text-gray-600">File: {file.name}</p>
                                <p className="mb-2 text-gray-600">Processing record {progress} of {total}</p>
                                <div className="w-full bg-gray-200 rounded-full h-4">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{ width: total > 0 ? `${(progress / total) * 100}%` : '0%' }}></div>
                                </div>
                                {isUploading ? (
                                    <div className="text-center mt-4">
                                        <button onClick={handleCancel} className="py-2 px-6 bg-red-500 text-white rounded-lg hover:bg-red-600">Cancel</button>
                                    </div>
                                ) : (
                                    <div className="text-center mt-4">
                                        <p className="text-lg text-green-600 font-semibold mb-2">Upload complete!</p>
                                        <p>{progress} records processed.</p>
                                        <button onClick={onClose} className="mt-2 py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
