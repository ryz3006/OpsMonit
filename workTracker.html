<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Work Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot, orderBy, where, deleteDoc, limit, startAfter, getDocs, updateDoc, arrayUnion, serverTimestamp, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
            getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot, orderBy, where, deleteDoc, limit, startAfter, getDocs, updateDoc, arrayUnion, serverTimestamp, arrayRemove
        };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            display: flex;
        }
        .timer-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        /* Style for sticky header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50; /* Ensure it's on top */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCCOH7T907XnZoGxJaESLQghUE0xSDPiHk",
            authDomain: "dalignzo.firebaseapp.com",
            projectId: "dalignzo",
            storageBucket: "dalignzo.appspot.com",
            messagingSenderId: "901156603087",
            appId: "1:901156603087:web:c95c9f4f714f8f0be263ba",
            measurementId: "G-36S66F65D6"
        };
        
        const ADMIN_EMAIL = "riyas.siddikk@6dtech.co.in";
        
        let app, auth, db;
        try {
            app = window.firebase.initializeApp(firebaseConfig);
            auth = window.firebase.getAuth(app);
            db = window.firebase.getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization error:", e);
        }

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            
            useEffect(() => {
                const unsubscribeAuth = window.firebase.onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        const userDocRef = window.firebase.doc(db, "users", currentUser.uid);
                        const unsubscribeUser = window.firebase.onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                setUserData(docSnap.data());
                            } else {
                                const newUserProfile = {
                                    email: currentUser.email,
                                    name: currentUser.displayName,
                                    teams: [],
                                    roles: currentUser.email === ADMIN_EMAIL ? ['admin'] : ['member']
                                };
                                window.firebase.setDoc(userDocRef, newUserProfile);
                                setUserData(newUserProfile);
                            }
                            setUser(currentUser);
                            setLoading(false);
                        });
                        return () => unsubscribeUser();
                    } else {
                        setUser(null);
                        setUserData(null);
                        setLoading(false);
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            const handleGoogleSignIn = async () => {
                const provider = new window.firebase.GoogleAuthProvider();
                try {
                    const result = await window.firebase.signInWithPopup(auth, provider);
                    const email = result.user.email;
                    if (!email.endsWith('@6dtech.co.in')) {
                        setAuthError("Access denied. Only members with a '6dtech.co.in' email are allowed.");
                        await window.firebase.signOut(auth);
                    } else {
                        setAuthError(null);
                    }
                } catch (error) {
                    console.error("Google Sign-in failed", error);
                    setAuthError(`Google Sign-in failed: ${error.message}`);
                }
            };
            
            const handleLogout = async () => {
                try {
                    await window.firebase.signOut(auth);
                } catch (error) {
                    console.error("Logout failed", error);
                }
            };

            if (loading) return <div className="text-center p-10">Loading Application...</div>;

            if (!user) {
                return <LoginScreen onLogin={handleGoogleSignIn} error={authError} />;
            }

            return <MainLayout user={user} userData={userData} onLogout={handleLogout} />;
        }
        
        // --- Screens & Layouts ---

        function LoginScreen({ onLogin, error }) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50">
                    <div className="text-center p-8 bg-white shadow-xl rounded-2xl max-w-md w-full">
                        <i className="fas fa-tasks fa-3x text-blue-600 mb-4"></i>
                        <h1 className="text-3xl font-bold text-gray-800">Work Tracker</h1>
                        <p className="text-gray-500 mt-2 mb-8">Log your work, track your time, stay productive.</p>
                        <button
                            onClick={onLogin}
                            className="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center"
                        >
                            <img src="https://www.google.com/favicon.ico" alt="Google icon" className="w-6 h-6 mr-3" />
                            Sign in with Google
                        </button>
                        {error && <p className="text-red-500 text-sm mt-4">{error}</p>}
                    </div>
                </div>
            );
        }

        function MainLayout({ user, userData, onLogout }) {
            const [selectedTeam, setSelectedTeam] = useState(null);
            const [isSettingsModalOpen, setSettingsModalOpen] = useState(false);
            const [liveTimers, setLiveTimers] = useState([]);
            const [activeTimerModalId, setActiveTimerModalId] = useState(null);

            const isAdmin = userData?.roles?.includes('admin');
            const hasTeams = userData?.teams && userData.teams.length > 0;

            useEffect(() => {
                // Set default team if available and none is selected
                if (hasTeams && !selectedTeam) {
                    setSelectedTeam(userData.teams[0]);
                }
            }, [userData, selectedTeam, hasTeams]);

            useEffect(() => {
                if (!user) return;
                const liveTimersQuery = window.firebase.query(
                    window.firebase.collection(db, `live_timers/${user.uid}/timers`)
                );
                const unsubscribeLiveTimers = window.firebase.onSnapshot(liveTimersQuery, (snapshot) => {
                    const timers = [];
                    snapshot.forEach(doc => timers.push({ id: doc.id, ...doc.data() }));
                    setLiveTimers(timers);
                });
                return () => unsubscribeLiveTimers();
            }, [user]);

            const activeTimerData = liveTimers.find(t => t.id === activeTimerModalId);

            return (
                <div className="font-sans">
                    <header className="sticky-header bg-white shadow-md p-4 flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-gray-800">Work Tracker</h1>
                        <div className="flex items-center space-x-4">
                             {hasTeams && (
                                <div className="flex items-center space-x-2">
                                    <label htmlFor="team-select" className="text-sm font-medium text-gray-700">Team:</label>
                                    <select 
                                        id="team-select"
                                        value={selectedTeam || ''}
                                        onChange={(e) => setSelectedTeam(e.target.value)}
                                        className="p-2 border rounded-md bg-gray-50 text-sm"
                                    >
                                        {userData.teams.map(team => <option key={team} value={team}>{team}</option>)}
                                    </select>
                                </div>
                             )}
                            <div className="text-right">
                                <p className="font-semibold">{user.displayName}</p>
                                <p className="text-xs text-gray-500">{user.email}</p>
                            </div>
                            <img src={user.photoURL} alt="User profile" className="w-10 h-10 rounded-full" />
                            <button onClick={onLogout} className="text-gray-500 hover:text-red-600" title="Logout"><i className="fas fa-sign-out-alt fa-lg"></i></button>
                            {isAdmin && <button onClick={() => setSettingsModalOpen(true)} className="text-gray-500 hover:text-blue-600" title="Settings"><i className="fas fa-cog fa-lg"></i></button>}
                        </div>
                    </header>
                    
                    <FloatingTimerBar timers={liveTimers} onRestore={setActiveTimerModalId} />

                    <main className="container mx-auto p-4 md:p-8">
                        {selectedTeam ? (
                            <Dashboard user={user} userData={userData} selectedTeam={selectedTeam} />
                        ) : (
                            <div className="text-center p-8 bg-white shadow-xl rounded-2xl max-w-md w-full mx-auto">
                                <h1 className="text-2xl font-bold text-gray-800">No Teams Assigned</h1>
                                <p className="text-gray-600 mt-4">You have not been assigned to any teams. If you are an admin, please go to Settings to create a team and assign yourself to it.</p>
                            </div>
                        )}
                    </main>

                    {isSettingsModalOpen && <SettingsModal onClose={() => setSettingsModalOpen(false)} />}
                    {activeTimerData && <LiveTimerModal timerData={activeTimerData} user={user} onStop={() => setActiveTimerModalId(null)} onMinimize={() => setActiveTimerModalId(null)} />}
                </div>
            );
        }

        function Dashboard({ user, userData, selectedTeam }) {
            const defaultSettings = { projects: [], customFields: [], confirmationTime: 30, autoStopTime: 60 };
            const [settings, setSettings] = useState(defaultSettings);
            const [workLogs, setWorkLogs] = useState([]);
            const [lastVisible, setLastVisible] = useState(null);
            const [isLastPage, setIsLastPage] = useState(false);
            
            const [isWorkLogModalOpen, setWorkLogModalOpen] = useState(false);
            const [isUploadModalOpen, setUploadModalOpen] = useState(false);

            const fetchWorkLogs = useCallback(async (next = false) => {
                let q = window.firebase.query(
                    window.firebase.collection(db, "manual_work_reports"),
                    window.firebase.where("user.email", "==", user.email),
                    window.firebase.orderBy("startTime", "desc"),
                    window.firebase.limit(25)
                );

                if (next && lastVisible) {
                    q = window.firebase.query(q, window.firebase.startAfter(lastVisible));
                }
                
                try {
                    const documentSnapshots = await window.firebase.getDocs(q);
                    const logs = [];
                    documentSnapshots.forEach((doc) => {
                        logs.push({ id: doc.id, ...doc.data() });
                    });
                    
                    setWorkLogs(logs);
                    setLastVisible(documentSnapshots.docs[documentSnapshots.docs.length - 1]);
                    setIsLastPage(documentSnapshots.docs.length < 25);
                } catch(e) {
                    console.error("Error fetching work logs:", e);
                    if (e.code === 'failed-precondition') {
                        alert("A database index is required for this query. Please follow the link in the console to create it.");
                    }
                }
            }, [user, lastVisible]);


            useEffect(() => {
                const settingsDocRef = window.firebase.doc(db, "app_settings", "config");
                const unsubscribeSettings = window.firebase.onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSettings({ ...defaultSettings, ...docSnap.data() });
                    } else {
                        window.firebase.setDoc(settingsDocRef, defaultSettings);
                    }
                });

                fetchWorkLogs();

                return () => unsubscribeSettings();
            }, [user, selectedTeam]);

            const handleSaveWorkLog = async (logData) => {
                if (logData.isLive) {
                    await window.firebase.addDoc(window.firebase.collection(db, `live_timers/${user.uid}/timers`), logData);
                } else {
                    await window.firebase.addDoc(window.firebase.collection(db, "manual_work_reports"), logData);
                    fetchWorkLogs();
                }
                setWorkLogModalOpen(false);
            };

            return (
                <>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <button onClick={() => setWorkLogModalOpen(true)} className="p-6 bg-green-500 text-white rounded-lg shadow-lg hover:bg-green-600 transition flex items-center justify-center text-xl font-semibold">
                            <i className="fas fa-play-circle mr-3"></i> Start New Work
                        </button>
                        <button onClick={() => { /* Logic for old work */ }} className="p-6 bg-blue-500 text-white rounded-lg shadow-lg hover:bg-blue-600 transition flex items-center justify-center text-xl font-semibold">
                            <i className="fas fa-plus-circle mr-3"></i> Add Old Work
                        </button>
                        <button onClick={() => setUploadModalOpen(true)} className="p-6 bg-purple-500 text-white rounded-lg shadow-lg hover:bg-purple-600 transition flex items-center justify-center text-xl font-semibold cursor-pointer">
                            <i className="fas fa-upload mr-3"></i> Upload CSV
                        </button>
                    </div>

                    <WorkLogsTable logs={workLogs} user={user} onNextPage={() => fetchWorkLogs(true)} isLastPage={isLastPage} onRefresh={fetchWorkLogs} />
                    
                    {isWorkLogModalOpen && <WorkLogModal settings={settings} user={user} onSave={handleSaveWorkLog} onClose={() => setWorkLogModalOpen(false)} />}
                    {isUploadModalOpen && <UploadModal user={user} currentProjects={settings.projects} onClose={() => setUploadModalOpen(false)} />}
                </>
            );
        }

        // --- Child Components ---
        
        function FloatingTimerBar({ timers, onRestore }) {
            const [isOpen, setIsOpen] = useState(false);
            if (timers.length === 0) return null;

            return (
                <div className="sticky-header bg-blue-600 text-white shadow-lg cursor-pointer">
                    <div 
                        onClick={() => setIsOpen(!isOpen)} 
                        className="container mx-auto p-2 flex items-center justify-between"
                    >
                        <div className="flex items-center space-x-3">
                           <i className="fas fa-stopwatch timer-pulse"></i>
                           <span className="font-semibold text-sm">Ongoing Timers</span>
                        </div>
                        <div className="flex items-center space-x-3">
                           <span className="bg-white text-blue-600 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">{timers.length}</span>
                           <i className={`fas fa-chevron-down transition-transform ${isOpen ? 'rotate-180' : ''}`}></i>
                        </div>
                    </div>
                    {isOpen && (
                        <div className="container mx-auto pb-2">
                             <div className="bg-blue-700 rounded-b-lg p-2 max-h-64 overflow-y-auto">
                                {timers.map(timer => (
                                    <div key={timer.id} className="mb-2 p-2 hover:bg-blue-800 rounded">
                                        <p className="font-semibold text-sm truncate">{timer.project}: {timer.ticketLink}</p>
                                        <div className="flex justify-between items-center">
                                            <span className={`text-xs ${timer.isPaused ? 'text-yellow-300' : 'text-green-300'}`}>{timer.isPaused ? 'Paused' : 'Running'}</span>
                                            <button onClick={() => onRestore(timer.id)} className="text-white font-bold text-sm hover:underline">View</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function LiveTimerModal({ timerData, user, onStop, onMinimize }) {
            const [elapsed, setElapsed] = useState(0);
            const [isConfirming, setConfirming] = useState(false);
            const timerRef = useRef(null);
            const confirmationTimeoutRef = useRef(null);
            const autoStopTimeoutRef = useRef(null);

            const calculateElapsed = useCallback(() => {
                if (timerData.isPaused) {
                    return timerData.totalElapsedTime || 0;
                }
                const now = Date.now();
                const resumeTime = timerData.lastResumedTime?.toMillis() || timerData.startTime.toMillis();
                const baseElapsedTime = timerData.totalElapsedTime || 0;
                return baseElapsedTime + (now - resumeTime);
            }, [timerData]);
            
            const handleStop = useCallback(async () => {
                clearInterval(timerRef.current);
                clearTimeout(confirmationTimeoutRef.current);
                clearTimeout(autoStopTimeoutRef.current);

                const finalEndTime = new Date();
                const finalElapsedTime = calculateElapsed();
                
                const finalLog = {
                    ...timerData,
                    startTime: new Date(finalEndTime.getTime() - finalElapsedTime),
                    endTime: finalEndTime,
                    isLive: false,
                };
                delete finalLog.id;
                delete finalLog.isPaused;
                delete finalLog.totalElapsedTime;
                delete finalLog.lastResumedTime;

                await window.firebase.addDoc(window.firebase.collection(db, "manual_work_reports"), finalLog);
                await window.firebase.deleteDoc(window.firebase.doc(db, `live_timers/${user.uid}/timers`, timerData.id));
                onStop();
            }, [timerData, user, onStop, calculateElapsed]);

            const resetTimeouts = useCallback(() => {
                // ... timer logic
            }, []);

            useEffect(() => {
                setElapsed(calculateElapsed());

                if (!timerData.isPaused) {
                    timerRef.current = setInterval(() => setElapsed(calculateElapsed()), 1000);
                    resetTimeouts();
                }

                return () => {
                    clearInterval(timerRef.current);
                    clearTimeout(confirmationTimeoutRef.current);
                    clearTimeout(autoStopTimeoutRef.current);
                };
            }, [timerData, calculateElapsed, resetTimeouts]);

            const handlePause = async () => {
                clearInterval(timerRef.current);
                clearTimeout(confirmationTimeoutRef.current);
                clearTimeout(autoStopTimeoutRef.current);

                const timerDocRef = window.firebase.doc(db, `live_timers/${user.uid}/timers`, timerData.id);
                await window.firebase.updateDoc(timerDocRef, {
                    isPaused: true,
                    totalElapsedTime: elapsed
                });
            };
            
            const handleResume = async () => {
                const timerDocRef = window.firebase.doc(db, `live_timers/${user.uid}/timers`, timerData.id);
                await window.firebase.updateDoc(timerDocRef, {
                    isPaused: false,
                    lastResumedTime: window.firebase.serverTimestamp()
                });
                resetTimeouts();
            };
            
            const handleConfirmContinue = () => {
                setConfirming(false);
                resetTimeouts();
            };

            const formatTime = (ms) => {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg">
                        <h2 className="text-2xl font-bold mb-2">Timer Running</h2>
                        <p className="text-gray-600 mb-4">{timerData.project}: {timerData.ticketLink}</p>
                        <p className="text-6xl font-mono text-center my-8 text-green-600">{formatTime(elapsed)}</p>
                        
                        {isConfirming && (
                            <div className="mb-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded">
                                <h4 className="font-bold text-yellow-800">Are you still working?</h4>
                                <p className="text-sm text-yellow-700">Timer will stop automatically if you don't respond.</p>
                                <button onClick={handleConfirmContinue} className="mt-2 bg-green-500 text-white py-1 px-3 rounded text-sm">Yes, continue tracking</button>
                            </div>
                        )}
                        
                        <div className="flex justify-between items-center">
                            <button onClick={onMinimize} className="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300">Minimize</button>
                            <div>
                                {timerData.isPaused ? (
                                    <button onClick={handleResume} className="py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 mr-2">Resume</button>
                                ) : (
                                    <button onClick={handlePause} className="py-2 px-4 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 mr-2">Pause</button>
                                )}
                                <button onClick={handleStop} className="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600">Stop</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function WorkLogsTable({ logs, user, onNextPage, isLastPage, onRefresh }) {
            const [selectedLogs, setSelectedLogs] = useState([]);

            const handleDelete = async (ids) => {
                if (!window.confirm(`Are you sure you want to delete ${ids.length} log(s)?`)) return;
                
                for (const id of ids) {
                    await window.firebase.deleteDoc(window.firebase.doc(db, "manual_work_reports", id));
                }
                setSelectedLogs([]);
                onRefresh();
            };

            const formatTime = (timestamp) => timestamp ? new Date(timestamp.seconds * 1000).toLocaleString() : 'N/A';
            const formatDuration = (start, end) => {
                if (!start || !end) return 'In Progress';
                const diff = (end.seconds - start.seconds) * 1000;
                if (diff < 0) return 'Invalid';
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                return `${hours}h ${minutes}m`;
            };

            return (
                <div className="bg-white p-4 rounded-lg shadow-md">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-700">My Work Logs</h2>
                        {selectedLogs.length > 0 && (
                            <button onClick={() => handleDelete(selectedLogs)} className="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition">
                                <i className="fas fa-trash-alt mr-2"></i>Delete Selected ({selectedLogs.length})
                            </button>
                        )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead>
                                <tr className="bg-gray-50 border-b">
                                    <th className="p-3 w-4"><input type="checkbox" onChange={(e) => setSelectedLogs(e.target.checked ? logs.map(l => l.id) : [])} /></th>
                                    <th className="p-3">Project</th>
                                    <th className="p-3">Ticket/Task</th>
                                    <th className="p-3">Start Time</th>
                                    <th className="p-3">End Time</th>
                                    <th className="p-3">Duration</th>
                                    <th className="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {logs.map(log => (
                                    <tr key={log.id} className={`border-b ${selectedLogs.includes(log.id) ? 'bg-blue-50' : 'hover:bg-gray-50'}`}>
                                        <td className="p-3"><input type="checkbox" checked={selectedLogs.includes(log.id)} onChange={() => setSelectedLogs(p => p.includes(log.id) ? p.filter(id => id !== log.id) : [...p, log.id])} /></td>
                                        <td className="p-3 font-medium">{log.project}</td>
                                        <td className="p-3">{log.ticketLink}</td>
                                        <td className="p-3">{formatTime(log.startTime)}</td>
                                        <td className="p-3">{formatTime(log.endTime)}</td>
                                        <td className="p-3 font-mono">{formatDuration(log.startTime, log.endTime)}</td>
                                        <td className="p-3">
                                            <button onClick={() => handleDelete([log.id])} className="text-gray-400 hover:text-red-500"><i className="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                     <div className="flex justify-end mt-4">
                        <button onClick={onNextPage} disabled={isLastPage} className="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 disabled:bg-gray-400">Next Page</button>
                    </div>
                </div>
            );
        }

        function SettingsModal({ onClose }) {
            const [activeTab, setActiveTab] = useState('General');
            const [settings, setSettings] = useState({});
            const [users, setUsers] = useState([]);
            const [teams, setTeams] = useState([]);
            const [newTeamName, setNewTeamName] = useState("");

            useEffect(() => {
                // Fetch all necessary admin data
                const unsubSettings = window.firebase.onSnapshot(window.firebase.doc(db, "app_settings", "config"), (doc) => setSettings(doc.data() || {}));
                const unsubUsers = window.firebase.onSnapshot(window.firebase.collection(db, "users"), (snap) => setUsers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubTeams = window.firebase.onSnapshot(window.firebase.collection(db, "teams"), (snap) => setTeams(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                
                return () => { unsubSettings(); unsubUsers(); unsubTeams(); };
            }, []);
            
            const handleAddTeam = async () => {
                if (!newTeamName.trim()) return;
                await window.firebase.addDoc(window.firebase.collection(db, "teams"), { name: newTeamName.trim() });
                setNewTeamName("");
            };
            
            const handleUserTeamChange = async (userId, teamName, isMember) => {
                const userDocRef = window.firebase.doc(db, "users", userId);
                if (isMember) {
                    await window.firebase.updateDoc(userDocRef, { teams: window.firebase.arrayUnion(teamName) });
                } else {
                    await window.firebase.updateDoc(userDocRef, { teams: window.firebase.arrayRemove(teamName) });
                }
            };

            const handleUserRoleChange = async (userId, role, hasRole) => {
                 const userDocRef = window.firebase.doc(db, "users", userId);
                if (hasRole) {
                    await window.firebase.updateDoc(userDocRef, { roles: window.firebase.arrayUnion(role) });
                } else {
                    await window.firebase.updateDoc(userDocRef, { roles: window.firebase.arrayRemove(role) });
                }
            }


            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <h2 className="text-2xl font-bold mb-6">Admin Settings</h2>
                        <div className="border-b border-gray-200 mb-4">
                            <nav className="-mb-px flex space-x-8">
                                <button onClick={() => setActiveTab('General')} className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'General' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>General</button>
                                <button onClick={() => setActiveTab('Teams')} className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'Teams' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Teams</button>
                                <button onClick={() => setActiveTab('Users')} className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'Users' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Users & Roles</button>
                            </nav>
                        </div>

                        <div className="flex-grow overflow-y-auto">
                            {activeTab === 'General' && <div>General Settings...</div>}
                            {activeTab === 'Teams' && (
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">Manage Teams</h3>
                                    <div className="flex gap-2 mb-4">
                                        <input value={newTeamName} onChange={e => setNewTeamName(e.target.value)} placeholder="New team name" className="flex-grow p-2 border rounded-md"/>
                                        <button onClick={handleAddTeam} className="bg-blue-500 text-white px-4 rounded-md">Add Team</button>
                                    </div>
                                    <div className="space-y-2">
                                        {teams.map(team => <div key={team.id} className="bg-gray-100 p-2 rounded">{team.name}</div>)}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'Users' && (
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">Manage Users</h3>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead><tr className="bg-gray-50">
                                                <th className="p-2">User</th><th className="p-2">Teams</th><th className="p-2">Roles</th>
                                            </tr></thead>
                                            <tbody>{users.map(u => (
                                                <tr key={u.id} className="border-b">
                                                    <td className="p-2">{u.name}<br/><span className="text-xs text-gray-500">{u.email}</span></td>
                                                    <td className="p-2">
                                                        <div className="flex flex-wrap gap-1">
                                                            {teams.map(team => (
                                                                <label key={team.id} className="flex items-center text-sm">
                                                                    <input type="checkbox" checked={u.teams?.includes(team.name)} onChange={e => handleUserTeamChange(u.id, team.name, e.target.checked)} className="mr-1"/>{team.name}
                                                                </label>
                                                            ))}
                                                        </div>
                                                    </td>
                                                    <td className="p-2">
                                                        <label className="flex items-center text-sm">
                                                            <input type="checkbox" checked={u.roles?.includes('admin')} onChange={e => handleUserRoleChange(u.id, 'admin', e.target.checked)} className="mr-1"/>Admin
                                                        </label>
                                                    </td>
                                                </tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex justify-end space-x-4 mt-8 pt-4 border-t">
                            <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                        </div>
                    </div>
                </div>
            );
        }

        function WorkLogModal({ settings, user, onSave, onClose }) {
            const [formData, setFormData] = useState({
                project: settings.projects[0] || '',
                ticketLink: '',
                description: '',
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                const now = new Date();
                const logData = {
                    ...formData,
                    user: { uid: user.uid, name: user.displayName, email: user.email },
                    isLive: true,
                    startTime: now,
                    lastResumedTime: now,
                    endTime: null,
                    isPaused: false,
                    totalElapsedTime: 0,
                };
                onSave(logData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg">
                        <h2 className="text-2xl font-bold mb-6">Start New Work</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Project</label>
                                <select name="project" value={formData.project} onChange={(e) => setFormData(p => ({...p, project: e.target.value}))} className="mt-1 block w-full p-2 border rounded-md" required>
                                    {settings.projects.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Ticket Link / Task Name</label>
                                <input type="text" name="ticketLink" value={formData.ticketLink} onChange={(e) => setFormData(p => ({...p, ticketLink: e.target.value}))} className="mt-1 block w-full p-2 border rounded-md" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="description" value={formData.description} onChange={(e) => setFormData(p => ({...p, description: e.target.value}))} rows="3" className="mt-1 block w-full p-2 border rounded-md"></textarea>
                            </div>
                        </div>
                        <div className="flex justify-end space-x-4 mt-8">
                            <button type="button" onClick={onClose} className="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button type="submit" className="py-2 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700">Start Timer</button>
                        </div>
                    </form>
                </div>
            );
        }

        function UploadModal({ user, currentProjects, onClose }) {
            const [file, setFile] = useState(null);
            const [progress, setProgress] = useState(0);
            const [total, setTotal] = useState(0);
            const [isUploading, setUploading] = useState(false);
            const isCancelledRef = useRef(false);
            const fileInputRef = useRef(null);

            const handleFileSelect = (event) => {
                const selectedFile = event.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    handleUpload(selectedFile);
                }
            };

            const parseCustomDate = (dateStr, timeStr) => {
                if (!dateStr || !timeStr) return null;
                const dateParts = dateStr.split('/');
                const timeParts = timeStr.split(':');
                if (dateParts.length !== 3 || timeParts.length !== 3) return null;
                const date = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]);
                return isNaN(date.getTime()) ? null : date;
            };

            const handleUpload = (fileToUpload) => {
                isCancelledRef.current = false;
                setUploading(true);
                Papa.parse(fileToUpload, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const records = results.data;
                        const newProjects = new Set();
                        setTotal(records.length);
                        
                        for (let i = 0; i < records.length; i++) {
                            if (isCancelledRef.current) break;
                            const record = records[i];
                            if (record.Project && !currentProjects.includes(record.Project)) {
                                newProjects.add(record.Project);
                            }
                            const startTime = parseCustomDate(record['Start Date'], record['Start Time']);
                            const endTime = parseCustomDate(record['End Date'], record['End Time']);

                            if (startTime && endTime && record.Email) {
                                const logData = {
                                    project: record.Project || 'N/A',
                                    ticketLink: record.Task || 'N/A',
                                    description: record.Description || '',
                                    startTime, endTime,
                                    user: { email: record.Email },
                                    uploader: { name: user.displayName, email: user.email },
                                    isLive: false,
                                };
                                await window.firebase.addDoc(window.firebase.collection(db, "manual_work_reports"), logData);
                            }
                            setProgress(i + 1);
                        }

                        if (newProjects.size > 0) {
                            const settingsDocRef = window.firebase.doc(db, "app_settings", "config");
                            await window.firebase.updateDoc(settingsDocRef, {
                                projects: window.firebase.arrayUnion(...Array.from(newProjects))
                            });
                        }
                        setUploading(false);
                    }
                });
            };

            const handleCancel = () => {
                isCancelledRef.current = true;
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-active">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold">Upload CSV</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>

                        {!file && (
                            <div className="text-center">
                                <p className="mb-4">Select a CSV file to upload work logs.</p>
                                <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileSelect} className="hidden" />
                                <button onClick={() => fileInputRef.current.click()} className="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Choose File
                                </button>
                            </div>
                        )}

                        {file && (
                            <div>
                                <p className="mb-2 text-gray-600">File: {file.name}</p>
                                <p className="mb-2 text-gray-600">Processing record {progress} of {total}</p>
                                <div className="w-full bg-gray-200 rounded-full h-4">
                                    <div className="bg-blue-600 h-4 rounded-full" style={{ width: total > 0 ? `${(progress / total) * 100}%` : '0%' }}></div>
                                </div>
                                {isUploading ? (
                                    <div className="text-center mt-4">
                                        <button onClick={handleCancel} className="py-2 px-6 bg-red-500 text-white rounded-lg hover:bg-red-600">Cancel</button>
                                    </div>
                                ) : (
                                    <div className="text-center mt-4">
                                        <p className="text-lg text-green-600 font-semibold mb-2">Upload complete!</p>
                                        <p>{progress} records processed.</p>
                                        <button onClick={onClose} className="mt-2 py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
